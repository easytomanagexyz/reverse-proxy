name: Deploy Reverse Proxy to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
  - name: Checkout code
    uses: actions/checkout@v3

  - name: Copy SSH key
    run: |
      echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
      chmod 600 key.pem

  - name: Deploy to EC2
    env:
      HOST: ${{ secrets.EC2_HOST }}
      USERNAME: ${{ secrets.EC2_USERNAME }}
    run: |
      ssh -i key.pem -o StrictHostKeyChecking=no $USERNAME@$HOST '
        set -e

        # Go to reverse-proxy directory (matches what you actually use on EC2)
        mkdir -p /home/ubuntu/www/nginx-reverse-proxy
        cd /home/ubuntu/www/nginx-reverse-proxy

        # If not a git repo, clone; otherwise hard-reset to main
        if [ ! -d ".git" ]; then
          echo "ðŸ”½ Cloning repository..."
          git clone https://github.com/easytomanagexyz/reverse-proxy.git .
        else
          echo "ðŸ”„ Pulling latest changes..."
          git fetch --all
          git reset --hard origin/main
        fi

        echo "ðŸ³ Restarting Docker containers..."

        # Use docker compose (plugin) if available, otherwise docker-compose
        if command -v docker compose >/dev/null 2>&1; then
          docker compose down || true
          docker compose up -d
        else
          sudo /usr/bin/docker-compose down || true
          sudo /usr/bin/docker-compose up -d
        fi

        echo "âœ… Reverse proxy deployment completed!"
      '

                
